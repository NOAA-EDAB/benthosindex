---
title: "Bottom Temperature Filling"
author: "Sarah Gaichas"
date: "`r Sys.Date()`"
output:
  html_document:
    code_fold: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
library(tidyverse)
library(tidync)
library(sf)

```

## Introduction

Similar to the forage index analysis, we will want to explore catchability covariates for the benthos indices.

For benthos, (benthivore predators and benthic prey) bottom temperature is likely a better covariate than surface temperature. 

So we need an alternative source of bottom temperature data for those survey stations that do not have an associated bottom temperature measurement. For the forage index, we kept in situ temperature measurements where they existed and filled with OISST temperatures for the date and nearest spatial location when in situ temperature was missing. We will follow the same logic here.

## Methods

The bottom temperature reanalysis data we have are from Hubert DuPontavice, as used in the Black Sea Bass assessment, the SOE, and other products. I will use similar extraction methods to those posted by Abby Tyrell for the BSB to ensure this is the same source data, even though I am matching a location rather than calculating aggregate metrics.

Abby Tyrell's and Scott Large's code is here: https://github.com/ScottLarge-NOAA/bsb/blob/main/docs/bsb_2024_update2.Rmd

Let's try extracting from ERDDAP, otherwise we can grab the local files from Scott's repo.

This is Abby and Scott's code; I don't have this original file but this code inspired code that works on my files:

```{r, eval=FALSE}
# url <- "http://nefsctest.nmfs.local:8080/erddap/griddap/duPontavice_bottom_temp_local.csv?sea_water_temperature_at_sea_floor%5B(1989-01-01T00:00:00Z):1:(2019-04-01T00:00:00Z)%5D%5B(35.9166666666667):1:(44.4166666666667)%5D%5B(-75.9166666666667):1:(-65.75)%5D"

# data <- read.csv(url) # this should work but seems like NEFSC is choking the download
data <- read.csv(here::here("data-raw/duPontavice_bottom_temp_local_4d04_943c_b2ef.csv"))

# data2 <- data[[2]][-1,] %>%
data2 <- data[-1,] %>%
  tidyr::drop_na() %>%
  dplyr::mutate(dplyr::across(2:4, as.numeric),
                dplyr::across(1, lubridate::as_date),
                year = lubridate::year(time),
                month = lubridate::month(time)) %>%
  dplyr::filter(month %in% 2:3) %>%
  dplyr::rename(value = sea_water_temperature_at_sea_floor)
```

But I don't have the local files so try this from https://github.com/ScottLarge-NOAA/bsb/blob/main/scripts/bsb_bottom_temp-reanalysis.R 

Test with the file I currently have; doesnt seem to have the same format so nope. Code here not working but inspired code that does.

```{r, eval=FALSE}
data_bt <- tidync("data-raw/bottomtemp/bottom_temp_combined_product_1959_2020.nc") %>% # original file from Hubert, NE shelf
  hyper_tibble(force = TRUE) %>%
  mutate(origin = as.Date(paste0(year, "-01-01"), tz = "UTC") - days(1),
         date = as.Date(day, origin = origin, tz = "UTC"),
         month = month(date)#,
         #day = day(date)
         ) 


  #group_by(longitude, latitude, year, month) %>% # calculate monthly mean
  #summarise(bt_temp = mean(sea_water_temperature_at_sea_floor, na.rm = TRUE))

```

Try viewing the individual year files from Hubert, see if code from the OISST download/conversion can work.

The original files are on google drive [here](https://drive.google.com/drive/folders/1H4eMpdfo3EKnmu0EJFwZyHKt237Y3heW).
Navigate to EDABranch_Drive/ITD/ERDDAP/Data/Bottom Temp from Hubert Revised by Joe v1

The files are already split by year and clipped to the NE. File name format is `bottom_temp_yyyy.nc`

This code tests reading one in, formatting date fields, and plotting.

```{r}

ncfile <- here::here("data-raw/bottomtemp/bt_revised_metadata_032024/bottom_temp_2020.nc")

### get time info and add to tibble ----
tunit <- ncmeta::nc_atts(ncfile, "time") %>%
  dplyr::filter(name == "units") %>%
  tidyr::unnest(cols = c(value))

# tunit for this file is days since 1950-1-1
origin <- as.Date("1950-01-01") 

bttest <- tidync::tidync(ncfile) |>
  tidync::hyper_tibble(force = TRUE) |>
  dplyr::mutate(date = as.Date(time-1, origin=origin),
                year = lubridate::year(date),
                month = lubridate::month(date),
                day = lubridate::day(date))
  

# plotting function modified from bluefish SST analysis
dailybtplot <- function(oneday){
  ggplot() +
    geom_tile(data = oneday, aes(x = longitude, y = latitude, fill = sea_water_temperature_at_sea_floor)) +
    geom_sf(data = ecodata::coast) +
    #geom_point(data = FishStatsUtils::northwest_atlantic_grid, aes(x = Lon, y = Lat), size=0.05, alpha=0.1) +
    scale_fill_gradientn(name = "Temp C",
                         limits = c(0.5, 31),
                         colours = c(scales::muted("blue"), "white",
                                     scales::muted("red"), "black")) +
    coord_sf(xlim = c(-77, -65), ylim = c(35, 45)) + 
    ecodata::theme_map() +
    ggtitle(paste("Bottom temp, mm-dd-yyyy:", unique(oneday$month),
                   unique(oneday$day), unique(oneday$year), sep = " "))
}

mar122020 <- bttest[bttest$month==3 & bttest$day==12,]
aug122020 <- bttest[bttest$month==8 & bttest$day==12,]

dailybtplot(mar122020)
dailybtplot(aug122020)


```
Save the tibbles as rds and then can read and spatially match using same function as for forage index?

First a function to make the tibble from the nc and reformat date

```{r, eval=FALSE}
nctotibble <- function(ncfile = ncfile){
  # tunit for this file is days since 1950-1-1
  origin <- as.Date("1950-01-01") 
  
  bttib <- tidync::tidync(ncfile) |>
    tidync::hyper_tibble(force = TRUE) |>
    dplyr::mutate(date = as.Date(time-1, origin=origin),
                  year = lubridate::year(date),
                  month = lubridate::month(date),
                  day = lubridate::day(date))
  
  return(bttib)
}

```

And a loop to save as rds, only do years in the `bt_revised_metadata_032024` folder
```{r, eval=FALSE}
years <- 1968:2020
for(i in years) {
  name <- here::here("data-raw/bottomtemp/bt_revised_metadata_032024", paste0("bottom_temp_",i, ".nc"))
  filename <- here::here("data-raw","bottomtemp", "bt_data", paste0("bt", i, ".rds"))
  text <- knitr::knit_expand(text = "bt{{year}} <- nctotibble(ncfile = name)
                                     saveRDS(bt{{year}}, filename)",
                             year = i)
  print(text)
  try(eval(parse(text = text)))
}
```

Test reading GLORYS files: they have a different time unit. of course

```{r}
ncfile <- here::here("data-raw/bottomtemp/GLORYS-20240515/glorys_01_30_2020_to_06_30_2021.nc")

### get time info and add to tibble ----
tunit <- ncmeta::nc_atts(ncfile, "time") %>%
  dplyr::filter(name == "units") %>%
  tidyr::unnest(cols = c(value))

# time is seconds since 1970-01-01 00:00:00
origin <- as.Date("1970-01-01")

# 86400 seconds in a day, according to google

bttest <- tidync::tidync(ncfile) |>
  tidync::hyper_tibble(force = TRUE) |>
  dplyr::mutate(date = as.Date((time/86400), origin=origin),
                year = lubridate::year(date),
                month = lubridate::month(date),
                day = lubridate::day(date))



```

Function to read in the GLORYS years 2021-2023. Split to full years and write them to the same format as 2020 and back. This version has whole file in return, not split to years.

```{r}
glorysnctotibble <- function(ncfile = ncfile){
  # time is seconds since 1970-01-01 00:00:00
  origin <- as.Date("1970-01-01") 
  
  bttib <- tidync::tidync(ncfile) |>
  tidync::hyper_tibble(force = TRUE) |>
  dplyr::mutate(date = as.Date((time/86400), origin=origin),
                year = lubridate::year(date),
                month = lubridate::month(date),
                day = lubridate::day(date))
  
  return(bttib)
}
```

